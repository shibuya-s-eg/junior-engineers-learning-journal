---
weight: 4
title: "DNSを完全に理解する"
date: 2025-04-13T00:00:00+09:00
lastmod: 2025-04-13T00:00:00+09:00
draft: true
author: "しぶや"
authorLink: "https://github.com/shibuya-s-eg"
description: "DNSを完全に理解する"
images: []
resources:
- name: "featured-image"
  src: "featured-image.png"

tags: ["Network"]
categories: ["Network"]

lightgallery: true
---

<!--
Todo:
- TLDR

-->

* DNS
    * CAAレコード
        * この意味
    * RSIGレコード
    * SPFレコード
    * DNS SEC
    * TSIG
    * カミンスキー攻撃
    * SPF
    * nslookup, digが行っていること。通信の中身
    * DNSアンプ攻撃
    * DNSリフレクタ攻撃
    * DNSSECは権威DNSとキャッシュDNSの間、クライアントとの間はdns over tlsとか
    * キャッシュポイズニングとID的なやつ
    * ポートランダマイゼーション　
    * 2.6.1
    * ファーミング
    * DNSアンプ
        * キャッシュサーバ公開しない
        * どうやってレスをでかくする？
    * DNSトンネリング
    * 権威DNSも返してくれるけどrecursion noなので、再起問い合わせしてくれない
    * FAST FLUX
    * Domain flux
    * IDNA
    * DDNS



こんにちは、しぶやです。
今回はDNSを完全に理解していきます。

本記事では、Linuxをベースに説明を行いますが、本質的な部分はWindowsにも通じる話だと思います。

## TL;DR

*
*
*

## 0　はじめに

読者のみなさんはDNSについて、どこまで理解していますか？
「名前解決してくれるやつ」くらいに思っていましたが、メールの認証で使われていたりといろいろと深い部分があるようです。
今回はDNSについて深堀って学んでみます。

## 1　DNS基礎

### 1.1　DNSとは？

DNSとは何でしょうか？まずは定義を見てみましょう。

> DNS(ディーエヌエス: Domain Name System)は、 インターネットの重要な基盤技術の一つで、 ドメイン名とIPアドレスの対応付けや、 メールの宛先ホストを指示するためのシステムです。

名前解決をするためのシステムということですね。

記事にはhosts.txsからDNSへとあることからも分かりますが、"/etc/hosts"はDNSではないようです。
システムではなく、テキストファイルという枠組みなのでしょう。

### 1.2　名前解決の流れ

ここで、Linuxでの名前解決を復習しましょう。Linuxではnsswitch.confで名前解決の優先度が記載されています。

{{< image src="etc_passwd.png" width="800px" height="600px" caption="/etc/nsswitch.conf" >}}


> hosts: files dns

これは、名前解決の方法の順番を表しています。
アプリケーションのプロセスはlibcライブラリのgetaddrinfo()などから、名前解決を行なっています。
このとき、上記のような設定になっていると、まず"/etc/hosts"を確認し、名前解決できなかった場合はDNSに確認しに行きます。
ここでいうDNSは"/etc/resolv.conf"に記載されているものです。

"/etc/nsswitch.conf"に出てくる主なものとその意味は以下です。

* files.../etc/hostsに従って名前解決を行う
* dns.../etc/resolv.confに従ってDNSを利用した名前解決を行う
* mdns4...マルチキャストDNSを使って名前解決を行う
* mymachines...systemdによって管理されているローカルの仮想マシンやコンテナの名前解決を行う

{{< admonition Note "マルチキャストDNSとは"  >}}
マルチキャストDNS（mDNS）とはその名の通り、マルチキャストで利用するDNSです。
具体的には以下のような特徴があります。
* 同一セグメント内のみで有効
* マルチキャスト宛に送信
* 受け取ったノードが応答を返す
{{< /admonition >}}


### 1.2　DNSの仕組み

DNSには大きく2つの種類があります。
* 権威DNSサーバ
* キャッシュDNSサーバ

権威DNSサーバはゾーンファイルを持っています。
ゾーンファイルには、名前解決に必要なドメイン名とIPアドレスの組を始め、いくつかの情報を持っています。
権威DNSサーバはこのゾーンファイルの情報を利用し、名前解決に対し応答を行っています。

一方で、キャッシュDNSサーバはゾーンファイルを持ちません。
キャッシュDNSはDNS要求を受け取り、クライアントの変わりに再帰的に権威DNSサーバなどに名前解決を行い、結果をクライアントに返します。
キャッシュという名前にもある通り、過去のデータはキャッシュに保存しており、DNS要求を受け取った際にキャッシュにレコードを持っていれば、再起問い合わせなしにそのままクライアントに返すことができます。

DNSの種類が分かったところで、世の中のDNSの動きを見てみたいと思います。

{{< image src="etc_passwd.png" width="800px" height="600px" caption="DNSの動き" >}}

上の図は実際に名前解決をする流れです。

0. ローカルでの名前解決\
Webサイト訪問でも何でも良いですが、クライアントがドメイン名を利用し通信を行おうとした際、1.1で説明した"/etc/nsswitch.conf"に従った名前解決の方法で名前解決を試みます。

1. クライアントがDNSキャッシュサーバへDNS要求\
"/etc/nsswitch.conf"でDNSの順番が来た際は、"/etc/resolv.conf"に記載されたDNSサーバに対し順番に名前解決を試みます。
一般的なPC利用をしている場合はキャッシュDNSサーバに問い合わせが行われるはずです。

2. キャッシュDNSサーバによる名前解決\
クライアントからのDNS要求に対し、キャッシュを持っていればそれをそのまま返します。
キャッシュを持っていない場合は、ルートDNSサーバに再起問い合わせを行います。

3. ルートDNSサーバによる名前解決\
キャッシュDNSサーバからDNS要求を受け取った際、ルートDNSサーバは受け取ったDNS要求の上位ドメインのDNSサーバの情報を返します。
上の例で言うと、「jpドメインの情報ならhoge.dns.jpが持っているよ〜」みたいな感じです。

4. 権威DNSサーバによる名前解決\
受け取ったDNS要求に対し、自身がゾーン情報を持っている場合はその情報を返します。
3と同じように、DNS要求を受けたドメイン情報を持つ、さらに下位のDNSサーバの情報を返す場合もあります。

以上がDNSの仕組みです。
世の中での動きが分かると理解が深まりますね。

{{< admonition Note "キャッシュDNSサーバの登録"  >}}
普段キャッシュDNSサーバなんて意識せずに利用できています。
これはなぜでしょうか？

答えはDHCPプロトコルにあります。
PCはWifiなどに接続した際、DCHPによりIPアドレスやデフォルトGWの情報を受けとります。
実はこの際に、DNSサーバの情報も受け取ることが多いのです。
これにより、DNSサーバを自ら設定する必要がなくなります。

家庭用のルータを利用した際は、ルータ自身がキャッシュDNSとしての機能を持っていたり、ISPのキャッシュDNSが利用されていたりします。
{{< /admonition >}}


{{< admonition tip "ルートDNS" >}}
ルートDNSサーバは世界に13個あります。
日本にも存在し、m.root-servers.netがJPRS（株式会社日本レジストリサービス）によって運用されています。

※ 昔は僕の母校にもおいてあったらしい。。（驚）
{{< /admonition >}}

### 1.3　DNSレコード

では、DNSのゾーンファイルとはどのようなものでしょうか？
以下はOSSのDNSであるbind vにデフォルトで組み込まれたゾーンファイルのテンプレートです。


具体的なレコードについて例と一緒に見ていきましょう。

＊ Aレコード
> example.com. IN A 192.168.0.1

最も一般的なレコードです。ドメイン名に対するIPアドレスを設定し、名前解決に利用されます。

＊ AAAAレコード
> example.com. IN AAAA 2001:db8::1

IPv6用のAレコードです。
＊ CNAMEレコード
> www.example.com. IN CNAME example.com.

ドメイン名のエイリアスを設定するためのレコードです。
最も簡単な例が上記のwww.example.comに訪れても、example.comに訪れるようにするという設定です。

なんとなく想像はつくかもしれませんが、クライアント（基本的にはキャッシュDNSサーバ）の動きとしては、返されたCNAMEに対し再びDNSクエリを送信します。

他にも以下のような例があります。

www.example.comのDNSクエリはCNAMEとしてlb.example.comを返します。lb.example.comは複数のAレコードを持っており、DNSクエリに応じて返すIPアドレスを変えることで負荷分散を行います。

＊ NSレコード
> example.com. IN CNAME ns1.example.com

NSレコードはドメインを権威DNSサーバに委任するためのレコードです。
すなわち、example.comのドメイン情報はns1.example.comが持っているよーを返すためのレコードです。
CNAMEと同じようにクライアント(キャッシュDNSサーバ)はNSレコードを元に再度DNSクエリを送信します。

{{< admonition tip "ルートDNSサーバのゾーンファイル" >}}
ルートDNSサーバはトップレベルドメインのDNSサーバの情報を持っています。これにより、DNS要求を各トップレベルドメインのDNSサーバに委任するのです。
具体的なゾーンファイルは以下のようになっているみたいです。
{{< /admonition >}}


＊ MXレコード

> example.com. IN MX 10 mail.example.com

MXレコードは送信先ドメインのメールサーバのドメインを得るためのレコードです。
メール送信時の流れは以下です。
1. 送信側のサーバはまずDNSに問い合わせてMXレコードを探す。
2. 見つかったMXレコードに記載されているメールサーバのドメインの名前解決を行う。\
※ すなわち、MXレコードで指定したドメインのAレコード/AAAAレコードも必要です。
3. 2で解決したIPアドレスにメールを送信する。

{{< admonition tip "DNSクエリのQuestion" >}}
DNSクエリに対し、IPアドレスを返す場合もあれば、メールサーバのドメイン名を返す場合もあると思います。
クライアントはこれをどのように要求し、DNSはどう見分けて返しているのでしょうか？

答えはDNSクエリの中にあります。
DNSエリにはQuestionセクションというセクションがあり、その中のTypeで要求するレコードタイプを指定します。
これにより、DNSは応答するレコードを判断しているのです。
{{< /admonition >}}

＊ TXTレコード

＊ DMARC

＊ SPF TXTレコード

＊ DKIMレコード

＊ SOAレコード

＊ SRVレコード


### 1.4　運用者からみたDNS


ここで、よりイメージを具体化するためにDNSの運用を見てみましょう。


## 2　通信から見るDNS


### 2.1　通信


### 2.2　DNSレコード

ルートDNSにはNSレコードがたくさんあるイメージ

### 2.3　可用性/冗長性

## 3　DNSのセキュリティ


### 2.4　セキュリティ





## 参考

[1] [インターネット10分講座：DNS](https://www.nic.ad.jp/ja/newsletter/No22/080.html)

