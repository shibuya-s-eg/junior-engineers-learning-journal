---
weight: 4
title: "ClamAVを完全に理解する"
date: 2025-03-18T00:00:00+09:00
lastmod: 2025-03-18T00:00:00+09:00
draft: false
author: "しぶや"
authorLink: "https://github.com/shibuya-s-eg"
description: "ClamAVを完全に理解する。"
images: []
resources:
- name: "featured-image"
  src: "featured-image.png"

tags: ["Security"]
categories: ["Security"]

lightgallery: true
---

こんにちは、しぶやです。\
近いうちにClamAVを利用する機会がありそうなので、これを機にClamAVを「完全に理解」していきたいと思います。

## TL;DR

*
*
*

## 1　ClamAV基礎

### 1.0　マルウェアとは？

そもそもマルウェアの定義は何なのか曖昧であったので、Wikipediaで調べてみます。
（Wikipediaは割と定義が純粋で変な解釈されていないイメージがあるため。また、十分な信頼性を示したいわけでもないので手軽にWikipediaで調べてます。）

**Wikipedia**では以下のように書かれています。
> マルウェア (malware) とは、不正かつ有害に動作させる意図で作成された悪意のあるソフトウェアや悪質なコードの総称。

つまり、**悪意のあるソフトウェア = マルウェア**のようですね。

{{< admonition Note "マルウェア感染とは？" >}}
それでは、**マルウェア感染**とは何なのでしょうか？

意外に明確な定義が見つかりませんでした。**ChatGPT**に聞いてみると以下のように帰ってきました。
> マルウェア感染の定義は、悪意のあるソフトウェア（マルウェア）が、ユーザーの意図しない形でデバイス、システム、またはネットワークに侵入し、実行されることによって、その正常な動作を妨害、情報の窃取、システムの破壊、もしくは攻撃者に対する遠隔操作の権限を与える状態を指します。
すなわち、実行されることによって悪意のある動作がされることのようです。
ポイントは侵入したあとに実行までされて初めて感染であり、インストールされただけでは、感染ではないようです。
改めて考えてみると、ウイルス対策ソフトがインストールされたソフトをウイルスと判定し、隔離した際は感染したとは言い難いですものね。

実行環境だけ整えてあとから実行されるパターンなどもありますが、この時点で感染なのでしょうか？
ウイルス対策の視点から考えてみると、「実行環境が整ったがその後のウイルススキャンで実行される前に削除された」となれば感染したとは言わない気がします。
そのため、やはり実行に成功して初めて感染と定義したほうが良さそうです。

では、実行されだけど昔のウイルスなどでまともに動作せずに終わった場合はどうなのでしょう？\
※ ここでの「動作しない」とは、実行に失敗することでなく、実行には成功したがマルウェアが目的としていた動作（C2サーバとの接続等）に成功していないことを考えています。
僕は、これは感染と考えています。感染したけど被害はなかったと。
根拠としては、実際に実行されてプログラムが正常に動作してしまった時点で、コンピュータの隔離や解析等の対応が予想されるからです。
この時点で感染したとして後続対応がはじまるイメージです。

実際には他と整合性をとるための定義の問題でしかないので、正解はないのかもしれません。
現状、**実行に成功して初めて感染**くらいの定義がしっくり来ていますが、もっと良い定義があるかもしれません。
{{< /admonition >}}

それでは、具体的なマルウェアの種類をみていきます。
ここでも、[Wikipedia](https://ja.wikipedia.org/wiki/%E3%83%9E%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2)の定義を参照します。

* （広義の）ウイルス\
自己伝染機能、潜伏機能、発病機能のいずれかをもつ加害プログラム

* （狭義の）ウイルス\
他のプログラムやファイルの一部を書き換え（寄生、感染）、自己複製する機能を持つマルウェア

* ワーム\
ウイルス同様自己増殖するが、ホストプログラムを持たず、単体で存在するプログラム

* バックドア\
外部からコンピュータを操るために作られたコンピュータへの不正な侵入経路

* トロイの木馬\
見無害なファイルやプログラムに偽装した上でコンピュータに侵入したあと悪意のある振る舞いをするもの

* スパイウェア\
コンピュータの内部情報を外部に勝手に送信する[19]ソフトウェア

* キーロガー\
キーボードからの入力を記録するプログラム

* ボット\
ボットネットと呼ばれる仕組みにより、IRCなどを利用して攻撃者から命令を受け取り、命令に応じてDDoS攻撃やスパムメール送信などを行うマルウェア
※ ボット自体は常駐してチャットで会話するなどといった機能を持つ任意のプログラムを指すもの

* ルートキット\
攻撃者が被害者のコンピュータに侵入したあとに用いるツールを集めたパッケージで、マルウェアとして被害者のコンピュータにしかけるもの。
侵入の発覚を防ぐログ改ざんツール、バックドアをしかけるツール、キーロガー、パスワードやクレジットカード情報等の窃盗ツールなどがある。

* ランサムウェア\
コンピュータをロックしたり重要なファイルを暗号化して読めなくするなどして被害者を困らせ，身代金 (ransom) を払えば元に戻すと脅迫するマルウェア

* スケアウェア\
ユーザの恐怖 (scare) 心を煽る偽の警告メッセージ（「PCから違法ポルノやウイルスが検出された」等）を表示し、問題を解決するには所定の金額を支払うようにと脅すマルウェア

* ダウンローダー\
サイズの小さなマルウェアで、攻撃者のサーバから被害者のコンピュータに実行ファイルなどをダウンロードするなどさらなる攻撃の足がかりにするもの。
本体内部に不正なプログラムが格納されており、実行時に実行可能ファイルに展開するはドロッパーともいう。

* アドウェア\
ユーザの望まない広告を勝手に出すソフトウェアである。

* ワイパー\
感染したコンピュータの補助記憶装置内のデータを完全消去して使用不能にするもの。


### 1.1　ClamAVとは？

まず、「ClamAVとは何か？」についてですが、[公式](https://www.synology.com/)では以下のように書かれています。

> ClamAV は、メール ゲートウェイでの電子メール スキャン用に特別に設計されたオープン ソース (GPLv2) のウイルス対策ツールキットです。
> 柔軟でスケーラブルなマルチスレッド デーモン、コマンド ライン スキャナー、自動データベース更新用の高度なツールなど、多数のユーティリティを提供します。
> パッケージの核となるのは、共有ライブラリの形式で利用できるウイルス対策エンジンです。
> （Google翻訳）

**ウイルス対策ツールキット**と説明しているようです。
最後の文にもある通り、パッケージの核となるウイルス対策エンジンを中心として、様々な機能/用途をもっているため、このように呼んでいるのでしょうか。
また、ClamAV自体はもともとメールのスキャン用に作れらようです。

{{< admonition tip "ウイルス対策とマルウェア対策" >}}
ClamAVは"ウイルス対策ソフト"と呼ばれていますが、機能的にはマルウェア対策ソフトです。
実際に、ワームやトロイの木馬などウイルス以外のマルウェアの検出にも対応しています。
これは、昔コンピュータウイルスが最初に流行り始めた際にアンチウイルスという言葉がセキュリティソフトを指す名称として定着したからだとか。
{{< /admonition >}}


ClamAVは現在、**Cisco System, Inc**によって提供されているようです。もともとメンテナンスを主導していた**Sourcefire**という会社が買収されたのだとか。

また、OSSのメンテナンス以外にも以下のことが行われています。
* メーリングリスト\
ソフトウェアのアップデート情報やデータベースの更新、技術的な議論などをメールで通知しています。
* チャット\
コミュニティ用にDiscordサーバを運営しています。
* マルウェア情報の管理\
新規のマルウェアや未検出のマルウェアを受け付けてレビュー/管理しています。

{{< admonition note "有名なウイルス対策ソフト" >}}
ChatGPTに商用含めウイルス対策ソフトの有名どこを聞いてみました。
| 製品名   | 提供元 |
|--------|------|
| Microsoft Defender for Endpoint   | Microsoft   |
| Symantec Endpoint Security   | Broadcom   |
| Trend Micro Apex One   | Trend Micro  |
| McAfee Endpoint Security |  McAfee |
| Cisco Secure Endpoint   | Cisco  |
| SentinelOne   | SentinelOne  |
| CrowdStrike Falcon   | CrowdStrike  |
| Sophos Intercept X   | Sophos  |
| ESET PROTECT   | ESET  |
{{< /admonition >}}


### 1.2　ClamAVの機能

それでは、ClamAVの具体的な機能を見ていきましょう。

ClamAVのウイルススキャンは幅広いファイルをカバーしています。
* ドキュメント形式：tar, zip, gzip等
* アーカイブ、圧縮ファイル：docx, xlsx, PDF等
* スクリプト：JS, PHP, HTML, VBS等
* 実行ファイル：exe, dll, elf等
* メール形式：eml, msg等
* イメージ：iso, vhd等

docxやxlsxから分かる通り、clamAVは**Linux専用ではない**です。
ただし、一部機能はLinuxしか対応していなかったりとLinuxに強い感じです。

ウイルススキャンの機能として、ユーザが任意のタイミングで行うウイルススキャンに加え、**オンアクセススキャン**があります。
これは、ユーザがファイルにアクセスしたときに該当ファイルをスキャンすることでリアルタイム保護を行うものです。

その他の機能としては、シグネチャデータベースのアップデート機能やclamAVのデーモンのリソースモニタリングなどがあります。

### 1.3　その他のウイルス対策ソフトとの違い

ClamAVはOSSであるため、無料で利用できます。
そのためか、**高いお金を払ってまではウイルス対策ソフトを導入したくないとき**にClamAVを入れるイメージがあります。
ここでは、実際にClamAVとその他のウイルス対策ソフトの機能を比較し、ウイルス対策ソフトにお金を払う価値を調べてみようと思います。
ここでは、その他のウイルス対策ソフトの代表として、Trellixを比較してみようと思います。

| 機能   | ClamAV |  Trellix |
|--------|------|-------|
| 静的ヒューリスティック解析  | △ | ○ |
| 動的ヒューリスティック解析 | × | ○ |
| リアルタイムスキャン | ○ | ○ |
| サンドボックス機能 | × | ○ |
| AI  | × |  ○ |
| ホワイトリスト型制御  | ○ |  ○ |
| 管理機能・UI | △ |  ○ |
| 自動修復  | × |  ○ |
| 商用サポート  | × |  ○ |
| 価格  | ○ |  × |
| その他  | カスタマイズ | 保護, 修復  |
※ 特定の製品についての記載ではなく、該当機能を持った製品があるかで見ています。

検知という意味では、動的ヒューリスティック解析、AI機能が大きな違いとしてあります。
実際にどれだけ検知できるかは不明ですが、未知のウイルスにも対応できるというの大きいと思います。
特にウイルス対策ソフトの対策として、ウイルスの中身を良い感じに書き換えられたときにも**振る舞いが似ていれば検知できる**というのは安心につながりますね。

また、その他に書いた**保護・修復**にも大きな違いがあるかと思います。
以下は、[Trellix公式](https://docs.trellix.com/ja-JP/bundle/endpoint-security-10.6.0-threat-prevention-product-guide-windows/page/GUID-7939E36B-8FC4-42F4-BE70-46AB2B9B0954.html)の記載内容です。
>**保護**
>
>脅威対策は、次の機能を使用して環境への侵入を防ぎ、システムを保護します。
>
>* アクセス保護 － 指定されたファイル、共有、レジストリ キー、レジストリ値へのアクセスを制限し、プロセスとサービスを脅威動作から防止または制限することにより、クライアント システムへの不要な変更を阻止します。
>
>* エクスプロイト防止 － 脅威対策は、コンテンツ更新のシグネチャを使用して、次のエクスプロイトを阻止します。
>   * バッファー オーバーフロー － バッファー オーバーフローを悪用して任意のコードを実行できないようにします。
>   * API の不正利用 － システム上で実行されている未知のアプリケーションまたは侵害されたアプリケーションによる悪質な API 呼び出しを防ぎます。
>   * ネットワーク侵入防止 (ネットワーク IPS) － ネットワーク トラフィックを拒否または低下させる DoS 攻撃および帯域幅指向攻撃から保護します。
>   * エキスパート ルール － 追加のパラメーターを使用して、アクセス保護カスタム ルールよりも柔軟なルールを作成できます。 ただし、エキスパート ルールを作成するには、McAfee 固有の構文を理解する必要があります。
>
>**検出**
>
>脅威対策は、次の機能を使用して環境内の脅威を検出します。
>
>* オンアクセス スキャン － ファイルの読み取り時と書き込み時に脅威をスキャンします。 システムがアイドル状態の場合にのみスキャンします。 マルウェア対策スキャン インターフェース (AMSI) と統合され、ブラウザー ベース以外のスクリプトの脅威に対するスキャン機能を強化しています。
>* オンデマンド スキャン － 事前定義のスキャンを今すぐまたはスケジュールに従って実行します。スパイウェア関連のレジストリ項目もスキャンし、クリーンアップします。
>* 不審なプログラム － スパイウェアやアドウェアなどの不審なプログラムを検出し、環境内での実行を阻止します。
>* 隔離 － 感染項目を隔離し、駆除または修復を試みます。あるいは、自動的に削除します。
>* ダッシュボードとモニター － 脅威対策の統計情報を表示します。スキャン時間、コンテンツの更新ステータス、攻撃が最も多いアプリケーションなどの情報が表示されます。
>* クエリーとレポート － 脅威対策の詳細情報を取得します。脅威数、スキャンの完了、検出に対する応答、誤検知回避イベント、McAfee GTI の感度レベルなどの情報が表示されます。
>* マルウェア対策の早期読み込み － Windows 8 以降のリリースに含まれている ELAM 機能のサポートを提供します。 ELAM は、ブートサイクル時に読み込まれたデバイス ドライバーのリストを収集します。スキャン サービスが実行されると、これらのドライバーがスキャンされます。
>
>**修正**
>
>脅威対策は、次の機能を使用してセキュリティ問題を修正し、検出を処理します。また、パフォーマンスを向上させ、保護機能を強化します。
>
>* アクション － 検出時に特定のアクションを実行します。
>* アラート － 検出時に通知を行い、フィルターでトラフィックを制限します。
>* Extra.DAT ファイル － ウイルスの大量発生を含む新しい脅威から保護します。
>* スケジュール スキャン － システムのパフォーマンスを低下させず、スキャンを迅速に実行するため、ピーク時以外にスキャンを実行します。
>* コンテンツ リポジトリ － クライアント システムに近いリポジトリにコンテンツ ファイルを移動することで、会社のインターネットまたはイントラネットで発生するトラフィック量を減らします。
>* ログ ファイル (Endpoint Security クライアント) － 検出項目の履歴情報を提供します。このファイルを使用して設定を変更し、保護機能を強化したり、システムのパフォーマンスを向上させることができます。
>* ダッシュボードとモニター － アクティビティを確認して、脅威対策の設定を調整します。

保護のアクセス保護機能はClamAVにはないのではないかと思います。これについては、ClamAVの機能が足りないというより、TrellixはEDRのような機能も持っている感じですかね。

また、修正については、管理機能・UIにもつながりますが、検知後に行う動作を具体的に設定できたり、ダッシュボードを持っていたりします。
他のソフトウェアと組み合わせるなどして自分で作成できる範疇と言われればそこまでなのかも知れないですが、やはりウイルス対策ソフト自身が多機能で、ユーザーフレンドリーに作られていると商用利用しやすいのは事実ですね。

最後にもちろん、ウイルス対策ソフトにコストをかける大きなメリットは商用サポートがあることですね。
これはウイルス対策ソフトにかぎた話ではありませんが。特に、



{{< admonition note "静的ヒューリスティック解析、動的ヒューリスティック解析" >}}

* 静的ヒューリスティック解析\
静的ヒューリスティック解析にも2種類あります。
    * 構造解析\
    コードやバイナリの中身をそのまま見て、ウイルス定義と一致するかを確認します。
    * 挙動推測型解析\
    コードやバイナリを解析し、発生するシステムコールなどを予測した上で怪しい構造がないかを確認します。

* 動的ヒューリスティック解析\
実際にウイルスを動作させ、怪しい振る舞いがないかを確認します。

ここで素人の私は、**挙動推測型解析と動的ヒューリスティック解析は同じじゃないか。結局、発生するシステムコールとか見ているだけで結果は一意に定まるのでは？**と思いました。
実際のところ、前者の場合は、動的に生成されるコードの展開であったり、実行環境依存のAPI呼び出しは解析できないという課題があります。
また、難読化についても、**コンパイルしたら同じではないか**と思いますが、無意味なコードの挿入であったりと解析が難しくなる部分はあるようです。
（ポリモーフィック・メタモーフィックコードという実行時に自分自身を変化させたり、コードの動作を変更させることで静的解析を回避する技術もあるようです。）
{{< /admonition >}}

### 1.3　ClamAVの構成要素

それでは、[ClamAVのドキュメント](https://docs.clamav.net/manual/Usage.html)から構成要素を見ていきます。

>**Daemon**
>
>The ClamAV Daemon, or clamd, is a multi-threaded daemon that uses libclamav to scan files for viruses. ClamAV provides a number of tools which interface with this daemon. They are, as follows:
>
>clamdscan - a simple scanning client\
>on-access scanning - provides real-time protection via a clamd instance\
>clamdtop - a resource monitoring interface for clamd

ClamAVのデーモンであるclamdが動いており、内部的にはlibclamavを利用してスキャンを実施しているようです。
スキャン意外にも、clamdのリソースを見るためのclamdtopがあるようです。

>Signature Testing and Management
>
>A number of tools allow for testing and management of signatures. Of note are the following:
>
>clambc - specifically for testing bytecode
>sigtool - for general signature testing and analysis
>freshclam - used to update signature database sets to the latest version

clambcはバイナリのテストを行うものです。
これは、独自のマルウェア解析ルールなどを書いた際に、それが正しく動作するか（ClamAVが扱えるか）を検証するためのものです。
作成・検証の対象になるのは拡張子が.bcのバイトコードシグネチャというやつらしいです。

sigtoolはシグネチャの管理、分析をするためのツールです。
そもそも「シグネチャってなんやねん。」みたいな話があるので、そこは後ほど見てみようと思います。

freshclamはシグネチャデータベースの更新を行います。

>**Configuration**
>
>The more complex tools ClamAV provides each require some degree of configuration. ClamAV supplies two example configuration files:
>
>clamd.conf - for configuring the behavior of the ClamAV Daemon clamd and associated tools
>freschclam.conf - for configuring the behavior of the signature database update tool, freshclam

設定ファイルです。

### 1.4　ClamAVのウイルススキャンを覗いてみる

ソースコードベースで何してるか見てみる。
どのような検知手法があるのかとか
シグネチャ見てしまったほうがよい？


## 2　検証


## 3　まとめ


winもある、dbのパスの中身、設定ファイルの内容、おんアクセススキャン、デーモン、メールフィルタリング、dbとスキャンの例、バージョン

## 参考

[1] [ClamAV](https://www.synology.com/)
[2] [WIKIPEDIA Antivirus software](https://en.wikipedia.org/wiki/Antivirus_software)
[3] [Trellix 脅威対策の主な内容]（https://docs.trellix.com/ja-JP/bundle/endpoint-security-10.6.0-threat-prevention-product-guide-windows/page/GUID-7939E36B-8FC4-42F4-BE70-46AB2B9B0954.html）
