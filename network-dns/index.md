# DNSを完全に理解する


<!--
Todo:
- TLDR

-->



こんにちは、しぶやです。
今回はDNSを完全に理解していきます。

本記事では、Linuxをベースに説明を行いますが、本質的な部分はWindowsにも通じる話だと思います。

## TL;DR

*
*
*

## 0　はじめに

読者のみなさんはDNSについて、どこまで理解していますか？
「名前解決してくれるやつ」くらいに思っていましたが、メールの認証で使われていたりといろいろと深い部分があるようです。
今回はDNSについて深堀って学んでみます。

## 1　ドメイン基礎

### 1.1　ドメイン名とIPアドレス

ドメイン名とは何でしょうか？

> ドメイン名とはインターネット上の住所のようなものです。

よくある説明ですね。
ドメイン名は人間が簡単にWebサイトなどにアクセスするために、IPアドレスの代わりに利用されます。

ドメイン名から対応するIPアドレスを得ることを**名前解決**と呼びます。
システム上でこの名前解決がうまく動作することでドメイン名を用いた検索などができます。

{{< admonition tip "IPアドレスによるメール送信" >}}

メール送信にもIPアドレスを利用することができます。
その場合、**hoge@[123.123.123.123]**のように[]をつけてIPアドレスを指定します。

※ gmail.comのmxレコードにあるドメインのIPアドレスを指定して送信してみましたが、アドレス不明と言われてしまいました。
Gmail自身がIPアドレス指定を許可していないのか、指定したサーバが異なるのか。
現状、理由は不明です。
{{< /admonition >}}


### 1.2　ドメインの管理

ドメイン管理において、重要な役割を担うのは以下です。
* ICANN
* レジストリ
* レジストラ

まず、レジストリについてです。
レジストリは".net"や".jp"などのトップレベルドメインを管理・運用している組織です。
現在1500以上のトップレベルドメインが存在し、一つのレジストリが複数のトップレベルドメインを管理・運用していたりします。

続いて、レジストラについてです。
レジストラはレジストリとユーザの間に入り、ドメイン名の登録やドメイン料金の徴収などを行います。
有名なレジストラには"お名前.com"などがありますね。

新たなドメイン名を利用したいときは、レジストラにドメイン登録申請を行うことで、レジストリに登録されることが分かりました。
では、トップレベルドメインを作ることは可能なのでしょうか？
ここで登場するのがICANNです。
ICANNはトップレベルドメインの審査・認可やレジストリ・レジストラの認定などを行っている組織です。
すなわちICANNがドメイン管理全体を統括しているようなイメージです。
トップレベルドメインの作成も一定の条件とお金が揃えば、ICANNに申請することで作成できるらしいです。


### 1.3　WHOIS

"WHOIS検索"を利用したことがある人も多いと思います。
僕も最初はWHOISっていうサービスを提供している団体がいるのだと思っていました。

実は、WHOISはプロトコルの名前です。
(仕組みのことをWHOISと呼ぶ場合もあるようです。)

WHOISはTCP/43番ポートを利用するプロトコルであり、ドメイン名やIPアドレスに関する情報を取得するために利用されます。
具体的には、登録者名や有効期限、レジストラ名、DNSサーバなどが分かります。
Linuxのコマンドからでも利用でき、その例が以下です。


{{< image src="whois-example.png" width="800px" height="600px" caption="WHOISコマンド" >}}

レジストリやレジストラの情報、更新日などもも見れますね。
続いて、WHOISのパケットも見てみましょう。

{{< image src="whois-packet-1.png" width="800px" height="600px" caption="WHOISクエリ" >}}
{{< image src="whois-packet-2.png" width="800px" height="600px" caption="WHOIS応答" >}}

WHOISにはDNSように様々な種類レコードがあったりしないため、クエリは非常にシンプルです。
それに対し、応答はテキスト形式の情報をたくさん返してきています。

非常にシンプルなプロトコルですね！

WHOISの登録はドメインの登録を行ったレジストリやレジストラに義務付けられています。
これにより、ドップレベルドメインのサーバへ問い合わせることでドメイン情報を取得できます。

{{< admonition tip "WHOISサーバの特定" >}}
実は先程のwhoisコマンド実行後、なぜか**whois.nic.io**にDNSクエリが送信されていました。

{{< image src="whois-packet-3.png" width="800px" height="600px" caption="WHOISサーバへの名前解決" >}}

これは、whoisクライアントにトップレベルドメインとそのwhoisサーバのドメインの対応表が登録されているためだそうです。

{{< /admonition >}}


## 2　DNS基礎

### 2.1　DNSとは？

DNSとは何でしょうか？まずは定義を見てみましょう。

> DNS(ディーエヌエス: Domain Name System)は、 インターネットの重要な基盤技術の一つで、 ドメイン名とIPアドレスの対応付けや、 メールの宛先ホストを指示するためのシステムです。

名前解決をするためのシステムということですね。

記事にはhosts.txsからDNSへとあることからも分かりますが、"/etc/hosts"はDNSではないようです。
システムではなく、テキストファイルという枠組みなのでしょう。


### 2.2　代表的なDNS製品

代表的なDNS製品には以下のようなものがあります。
* BIND\
OSSの最も有名なやつです。
* Unbound...キャッシュ専用のOSSです。
* PowerDNS...SQL連携できるOSSです。

* Microsoft DNS Server
* Amazon Route 53
* Cloudflare DNS


## 3　DNSの仕組み

### 3.1　ホストの名前解決の流れ

ここで、Linuxでの名前解決を復習しましょう。Linuxではnsswitch.confで名前解決の優先度が記載されています。

{{< image src="nsswitch-conf.png" width="800px" height="600px" caption="/etc/nsswitch.conf" >}}


> hosts: files dns

これは、名前解決の方法の順番を表しています。
アプリケーションのプロセスはlibcライブラリのgetaddrinfo()などから、名前解決を行なっています。
このとき、上記のような設定になっていると、まず"/etc/hosts"を確認し、名前解決できなかった場合はDNSに確認しに行きます。
ここでいうDNSは"/etc/resolv.conf"に記載されているものです。

"/etc/nsswitch.conf"に出てくる主なものとその意味は以下です。

* files.../etc/hostsに従って名前解決を行う
* dns.../etc/resolv.confに従ってDNSを利用した名前解決を行う
* mdns4...マルチキャストDNSを使って名前解決を行う
* mymachines...systemdによって管理されているローカルの仮想マシンやコンテナの名前解決を行う

{{< admonition Note "マルチキャストDNSとは"  >}}
マルチキャストDNS（mDNS）とはその名の通り、マルチキャストで利用するDNSです。
具体的には以下のような特徴があります。
* 同一セグメント内のみで有効
* マルチキャスト宛に送信
* 受け取ったノードが応答を返す
{{< /admonition >}}


### 3.2　DNSの名前解決の流れ

DNSには大きく2つの種類があります。
* 権威DNSサーバ
* キャッシュDNSサーバ

権威DNSサーバはゾーンファイルを持っています。
ゾーンファイルには、名前解決に必要なドメイン名とIPアドレスの組を始め、いくつかの情報を持っています。
権威DNSサーバはこのゾーンファイルの情報を利用し、名前解決に対し応答を行っています。

一方で、キャッシュDNSサーバはゾーンファイルを持ちません。
キャッシュDNSはDNS要求を受け取り、クライアントの変わりに再帰的に権威DNSサーバなどに名前解決を行い、結果をクライアントに返します。
キャッシュという名前にもある通り、過去のデータはキャッシュに保存しており、DNS要求を受け取った際にキャッシュにレコードを持っていれば、再起問い合わせなしにそのままクライアントに返すことができます。

DNSの種類が分かったところで、世の中のDNSの動きを見てみたいと思います。

{{< image src="resolv-conf.png" width="800px" height="600px" caption="/etc/resolv.conf" >}}

上の図は実際に名前解決をする流れです。

0. ローカルでの名前解決\
Webサイト訪問でも何でも良いですが、クライアントがドメイン名を利用し通信を行おうとした際、1.1で説明した"/etc/nsswitch.conf"に従った名前解決の方法で名前解決を試みます。

1. クライアントがDNSキャッシュサーバへDNS要求\
"/etc/nsswitch.conf"でDNSの順番が来た際は、"/etc/resolv.conf"に記載されたDNSサーバに対し順番に名前解決を試みます。
一般的なPC利用をしている場合はキャッシュDNSサーバに問い合わせが行われるはずです。

2. キャッシュDNSサーバによる名前解決\
クライアントからのDNS要求に対し、キャッシュを持っていればそれをそのまま返します。
キャッシュを持っていない場合は、ルートDNSサーバに再起問い合わせを行います。

3. ルートDNSサーバによる名前解決\
キャッシュDNSサーバからDNS要求を受け取った際、ルートDNSサーバは受け取ったDNS要求の上位ドメインのDNSサーバの情報を返します。
上の例で言うと、「jpドメインの情報ならhoge.dns.jpが持っているよ〜」みたいな感じです。

4. 権威DNSサーバによる名前解決\
受け取ったDNS要求に対し、自身がゾーン情報を持っている場合はその情報を返します。
3と同じように、DNS要求を受けたドメイン情報を持つ、さらに下位のDNSサーバの情報を返す場合もあります。

以上がDNSの仕組みです。
世の中での動きが分かると理解が深まりますね。

{{< admonition Note "キャッシュDNSサーバの登録"  >}}
普段キャッシュDNSサーバなんて意識せずに利用できています。
これはなぜでしょうか？

答えはDHCPプロトコルにあります。
PCはWifiなどに接続した際、DCHPによりIPアドレスやデフォルトGWの情報を受けとります。
実はこの際に、DNSサーバの情報も受け取ることが多いのです。
これにより、DNSサーバを自ら設定する必要がなくなります。

家庭用のルータを利用した際は、ルータ自身がキャッシュDNSとしての機能を持っていたり、ISPのキャッシュDNSが利用されていたりします。
{{< /admonition >}}


{{< admonition tip "ルートDNS" >}}
ルートDNSサーバは世界に13個あります。
日本にも存在し、m.root-servers.netがJPRS（株式会社日本レジストリサービス）によって運用されています。

※ 昔は僕の母校にもおいてあったらしい。。（驚）
{{< /admonition >}}

## 3　DNSレコード

では、DNSのゾーンファイルとはどのようなものでしょうか？
以下はOSSのDNSであるbind vにデフォルトで組み込まれたゾーンファイルのテンプレートです。


具体的なレコードについて例と一緒に見ていきましょう。

＊ Aレコード
```
example.com. IN A 192.168.0.1
```

最も一般的なレコードです。ドメイン名に対するIPアドレスを設定し、名前解決に利用されます。

＊ AAAAレコード
```
example.com. IN AAAA 2001:db8::1
```
IPv6用のAレコードです。

＊ CNAMEレコード
```
www.example.com. IN CNAME example.com.
```

ドメイン名のエイリアスを設定するためのレコードです。
最も簡単な例が上記のwww.example.comに訪れても、example.comに訪れるようにするという設定です。

なんとなく想像はつくかもしれませんが、クライアント（基本的にはキャッシュDNSサーバ）の動きとしては、返されたCNAMEに対し再びDNSクエリを送信します。

他にも以下のような例があります。

www.example.comのDNSクエリはCNAMEとしてlb.example.comを返します。lb.example.comは複数のAレコードを持っており、DNSクエリに応じて返すIPアドレスを変えることで負荷分散を行います。

＊ NSレコード
```
example.com. IN CNAME ns1.example.com
```

NSレコードはドメインを権威DNSサーバに委任するためのレコードです。
すなわち、example.comのドメイン情報はns1.example.comが持っているよーを返すためのレコードです。
CNAMEと同じようにクライアント(キャッシュDNSサーバ)はNSレコードを元に再度DNSクエリを送信します。

{{< admonition tip "ルートDNSサーバのゾーンファイル" >}}
ルートDNSサーバはトップレベルドメインのDNSサーバの情報を持っています。これにより、DNS要求を各トップレベルドメインのDNSサーバに委任するのです。
具体的なゾーンファイルは以下のようになっているみたいです。
{{< /admonition >}}


＊ MXレコード
```
example.com. IN MX 10 mail.example.com
```

MXレコードは送信先ドメインのメールサーバのドメインを得るためのレコードです。
メール送信時の流れは以下です。
1. 送信側のサーバはまずDNSに問い合わせてMXレコードを探す。
2. 見つかったMXレコードに記載されているメールサーバのドメインの名前解決を行う。\
※ すなわち、MXレコードで指定したドメインのAレコード/AAAAレコードも必要です。
3. 2で解決したIPアドレスにメールを送信する。

{{< admonition tip "DNSクエリのQuestion" >}}
DNSクエリに対し、IPアドレスを返す場合もあれば、メールサーバのドメイン名を返す場合もあると思います。
クライアントはこれをどのように要求し、DNSはどう見分けて返しているのでしょうか？

答えはDNSクエリの中にあります。
DNSエリにはQuestionセクションというセクションがあり、その中のTypeで要求するレコードタイプを指定します。
これにより、DNSは応答するレコードを判断しているのです。
{{< /admonition >}}

* TXTレコード

DNSのTXTレコードはドメインの情報を自由に記述するレコードです。
TXTレコードを利用したものとして、メールで利用されるSPFレコードやDKIMレコードが有名です。

* SPFレコード、DKIMレコード、DMARCレコード
この辺りはメールの送信ドメイン認証のために使われるレコードです。DNSのレコードタイプとしてはTXTです。
これらの詳細は「メールを完全に理解する」で確認しようと思います。今はテキストとしてメールのドメイン認証に使うレコードを持っているんだなくらいに思っておきましょう。

* SOAレコード

```
example.com. IN SOA ns1.example.com. hostmaster.example.com. (
2025041601 ; serial
3600 ; refresh
600 ; retry
604800 ; expire
86400 ; minimum
)
```

SOAとは「Start of Authority」の略です。権威の起点を示しています。
SOAレコードはゾーンに必ずに一つだけ存在し、ゾーンに関する様々な情報を保持しています。

上記の例の意味は以下です。
＊ ns1.example.com. ... プライマリDNSサーバ
＊ hostmaster.example.com. ... 管理者メールアドレス
＊ serial ... シリアル番号
＊ reflesh ... リフレッシュ間隔(秒)
＊ retry ... リトライ間隔(秒)
＊ expire ... 有効期限(秒)
＊ minimum ... キャッシュ最小TTL


* SRVレコード

```
_ldap._tcp.example.com. 3600 IN SRV 10 5 389 ldapserver.example.com.
```

SRVレコードでは、接続先のサービス情報を提供します。
上の例からは、以下のようなサービス情報が分かります。
* LDAPサーバ
* L4プロトコルはTCP
* 対象ドメインはexample.com
* ポート番号389
* ホスト名はldapserver.example.com

* CAAレコード

不正な証明書発行を防ぐためのものです。
詳細は7章のセキュリティの文脈で説明します。

* RSIGレコード

ドメイン認証に利用されるレコードです。
詳細は7章のセキュリティの文脈で説明します。

## 4　運用者からみたDNS

ここで、よりイメージを具体化するためにDNS/ドメインの運用を見てみましょう。
ここでは、適当に立てたWebサーバを外部に公開し、ドメイン名でアクセスできるようにするケースを考えます。

0. 公開Webサーバの準備
ここでは詳しい説明は飛ばします。Webサーバを立て、外部からIPアドレスでアクセスできるようにします。

1. ドメインの取得
まずはドメインを取得します。
この時に利用するのがレジストラです。
有名なレジストラとしては"お名前.com"などがありますね。
以下はお名前.comでドメインを取得するときの画面です。


{{< image src="onamaecom-domain.png" width="800px" height="600px" caption="お名前.comの写真" >}}

このように、ドメイン名によっては無料で取得できるものも多くあります。アカウントさえ登録すれば、簡単にドメインを取得できます。

2. DNSへの登録
前節であったようなレコードをDNSにサーバに登録する必要があります。DNSサーバの登録では大きく2つの分岐があります。

＊ 自前DNSサーバを利用する\
自分でDNSサーバを用意し、そこにゾーンファイルを置きます。
＊ 他社のDNSに相乗りする\
他社のDNSにレコードを登録します。今回の例だと簡単なのはレジストラが提供しているDNSサーバを利用する方法です。
以下がお名前.comのDNSサーバの登録画面です。

{{< image src="onamaecom-dns.png" width="800px" height="600px" caption="お名前.comの登録画面" >}}


レジストラが提供するDNSサーバ以外の例として、クラウドが提供するDNSサーバがあります。
クラウドでWebサーバを構築している場合はそちらに登録するのが良いと思います。

3. DNSレコードの伝播/アクセス確認

DNSレコードの伝播には時間がかかる可能性があります。
これはキャッシュDNSサーバが古いレコードの情報を持っている可能性があるためです。
DNSキャッシュサーバはDNSレコードに記載されているTTL(Time to Live)の時間が経つまでは再起問い合わせを行わずキャッシュのデータを返します。
このためDNSキャッシュサーバのキャッシュが更新されるまで待つ必要があるのです。

DNSレコードの伝播が終われば、アクセス確認をして終わりです。



{{< admonition tip "DDNS" >}}
DDNSとはDynamic DNSの略です。自宅鯖とかでよく見ますね。
DDNSは、ISPから割り当てられた動的IPアドレスをドメインに紐づけるためにあります。これにより、サーバのIPアドレスが変わっても同じドメインでアクセスできるようになります。

仕組みとしては単純です。サーバ側でWAN側IPが変わった時にDDNSサーバに対し、IPアドレスが変わったことを通知し、DDNSがドメインに対応するIPを書き換えるのです。ここでは主にHTTPリクエストでAPIを叩く方式が利用されているようです。
{{< /admonition >}}


## 5　DNSの通信

### 5.1　ヘッダフォーマット

DNSはクエリとレスポンスが同じフォーマットを利用します。

大きく分けると以下のセクションに分割されます。

| セクション |  サイズ   |  用途   |
|------------|-----------|---------|
| ヘッダ     |  12バイト |  クエリ/応答に関する情報       |
| Question   |  可変     |  対象のドメイン名とレコードタイプの指定       |
| Answer     |  可変     |  リクエストに応じたレコード       |
| Authority  |  可変     |  再起問い合わせで使用されるNSレコードのリスト       |
| Additional |  可変     |  追加のレコード(NSレコードに対するAレコードなど)       |


### 5.2　パケット解析

    * nslookup, digが行っていること。通信の中身

## 6　可用性

## 7　セキュリティ

### 7.1　DNSへの攻撃

* ゾーン転送要求による登録情報の収集
* DNSキャッシュポイズニング
* カミンスキー攻撃
* DNSレフレクション(アンプ)攻撃
* DNS水攻め攻撃
* DNSトンネリング
* ファーミング

   * IDNA

#### 7.2　DNSセキュリティ

    * DNS SEC
     * DNSSECは権威DNSとキャッシュDNSの間、クライアントとの間はdns over tlsとか
   * キャッシュポイズニングとID的なやつ
    * ポートランダマイゼーション　
    * TSIG
* DNSアンプ
        * キャッシュサーバ公開しない
        * どうやってレスをでかくする？
    * 権威DNSも返してくれるけどrecursion noなので、再起問い合わせしてくれない
* パッシブDNS



{{< admonition tip "FAST FLUXとDomain flux" >}}

{{< /admonition >}}

## 8　まとめ


## 参考

[1] [インターネット10分講座：DNS](https://www.nic.ad.jp/ja/newsletter/No22/080.html)
https://github.com/EmilHernvall/dnsguide/tree/master
https://zenn.dev/gorogoroumaru/articles/00ca59c178535e

